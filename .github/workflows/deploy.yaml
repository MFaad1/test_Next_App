AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy Next.js app on AWS Amplify using CodePipeline

Parameters:
  GitHubOAuthToken:
    Type: String
    Description: GitHub OAuth token for accessing the repository
    NoEcho: true  # Prevent the token from being displayed during stack creation/update

Resources:
  AmplifyApp:
    Type: AWS::Amplify::App
    Properties:
      Name: MyNextApp
      Repository: https://github.com/MFaad1/test_Next_App
      Branch: pr-main

  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "codepipeline.amazonaws.com"
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "codepipeline:StartPipelineExecution"
                Resource: "*"

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: MyPipeline
      RoleArn: !GetAtt PipelineRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              Configuration:
                Owner: MFaad1
                Repo: test_Next_App
                Branch: pr-main
                OAuthToken: !Ref GitHubOAuthToken
              OutputArtifacts:
                - Name: SourceOutput
        - Name: Build
          Actions:
            - Name: BuildAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName: MyCodeBuildProject
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: BuildOutput
        - Name: Deploy
          Actions:
            - Name: DeployAction
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: Amplify
                Version: "1"
              Configuration:
                AppId: !GetAtt AmplifyApp.AppId
                BranchName: pr-main
              InputArtifacts:
                - Name: BuildOutput
